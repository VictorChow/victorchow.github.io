---
layout: post
title: IDEA æ’ä»¶å¼€å‘ï¼ˆäºŒï¼‰ å¸¸ç”¨å…ƒç´ å’Œæ–¹æ³•
date: 2020-07-24
categories: code
tags: IDEA
typora-root-url: ../../victorchow.github.io
---

> 

# PSI ç³»ç»Ÿ

## PSI

PSIï¼ˆProgram Structure Interfaceï¼‰æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé¡¹ç›®ä¸­çš„ä¸€åˆ‡éƒ½å¯ä»¥è¡¨ç¤ºä¸º PSI å¯¹è±¡ï¼Œä¾‹å¦‚æ–‡ä»¶å¯ä»¥è¡¨ç¤ºä¸º PsiFileï¼Œç±»å¯ä»¥è¡¨ç¤ºä¸º PsiClass ç­‰

### PSI Element

PSI Element æ˜¯ PSI ç³»ç»Ÿä¸‹çš„åŸºç±»ï¼ŒPsiFileã€PsiClass ç­‰ç­‰éƒ½æ˜¯ä¸€ä¸ªä¸ªå…·ä½“çš„ PsiElement å®ç°ï¼Œæ’ä»¶å¼€å‘çš„ä¸»è¦å·¥ä½œå°±æ˜¯é’ˆå¯¹ä¸åŒçš„ PsiElement è¿›è¡Œåˆ†æå’Œå¤„ç†

# å¸¸ç”¨å¯¹è±¡

## PsiFile

 åº”ç”¨ä¸­çš„å„ç§æ–‡ä»¶ï¼Œä¾‹å¦‚ .javaã€.xml æ–‡ä»¶ç­‰

* é€šè¿‡ Action è·å–ï¼š`event.getData(LangDataKeys.PSI_FILE);`

* é€šè¿‡ VirtualFile è·å–ï¼š`PsiManager.getInstance(project).findFile();`

* é€šè¿‡ Document è·å–ï¼š`PsiDocumentManager.getInstance(project).getPsiFile();`

* é€šè¿‡ Element è·å–ï¼š`psiElement.getContainingFile();`

* é€šè¿‡æ–‡ä»¶åè·å–ï¼š`FilenameIndex.getFilesByName(project, name, scope);`

### VirtualFile ä¸ PsiFile çš„åŒºåˆ«ï¼š

* VirtualFile ç±»ä¼¼äº Java é‡Œçš„ Fileï¼Œå¯ä»¥åšä¸€äº›åˆ å‡ã€é‡å‘½åç­‰æ“ä½œ

* PsiFile æ˜¯è¢« PSI å°è£…è¿‡çš„ï¼Œå’Œ PSI ä¸‹çš„å…¶ä»– Element å…ƒç´ ç›¸é€š

## PsiDirectory

åº”ç”¨ä¸­çš„ç›®å½•

* é€šè¿‡ PsiFileï¼š`psiFile.getContainingDirectory();`

## PsiJavaFile

Javaæºæ–‡ä»¶ï¼Œå¦‚ Test.java

* é€šè¿‡ PsiFile å¼ºè½¬ï¼š`(PsiJavaFile) psiFile;`

## PsiClass

æŸä¸ªç±»ï¼ŒåŒ…æ‹¬æ–‡ä»¶é‡Œçš„å†…éƒ¨ç±»

* é€šè¿‡ PsiJavaFile è·å–ï¼š`javaFile.getClasses();`

## PsiMethod

ç±»ä¸­çš„æŸä¸ªæ–¹æ³•

* é€šè¿‡ PsiClass è·å–ï¼š`psiClass.getMethods();`

## PsiField

ç±»ä¸­çš„æŸä¸ªå±æ€§

* é€šè¿‡ PsiClass è·å–ï¼š`psiClass.getFields();`

## PsiParameterList

æ–¹æ³•ä¸­çš„å‚æ•°

* é€šè¿‡ PsiMethod è·å–ï¼š`psiMethod.getParameterList();`

## PsiAnnotation

å„ç§åœ°æ–¹çš„æ³¨è§£

* é€šè¿‡èƒ½è¢«æ³¨è§£æ ‡è®°çš„å…ƒç´ ï¼š`jvmAnnotatedElement.getAnnotations();`

## Document

ä»¥çº¯æ–‡æœ¬æ ¼å¼è®¿é—®æˆ–è€…ä¿®æ”¹æ–‡ä»¶å†…å®¹

* é€šè¿‡ Action è·å–ï¼š`event.getData(PlatformDateKeys.EDITOR).getDocument();`
* é€šè¿‡ PsiFile è·å–ï¼š`PsiDocumentManager.getInstance().getDocument();`

# å¸¸ç”¨æ–¹æ³•

## åˆ›å»º ElementFactory

```java
PsiElementFactory factory = JavaPsiFacade.getElementFactory(project);
```

## ç¼–è¾‘ PsiClass

Intellij Platform ä¸å…è®¸åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œå®æ—¶çš„æ–‡ä»¶å†™å…¥ï¼Œè€Œéœ€è¦é€šè¿‡ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥è¿›è¡Œ 

```java
WriteCommandAction.runWriteCommandAction(project, () -> {
  	//do sth.
});
```

## æ ¼å¼åŒ–ä»£ç 

```java
CodeStyleManager.getInstance(project).reformat(element);
```

## å¯¼å…¥ç±»

```java
JavaCodeStyleManager manager = JavaCodeStyleManager.getInstance(project);
manager.optimizeImports(file);
manager.shortenClassReferences(targetClass);
```

## Find Usages

```java
Query<PsiReference> query = ReferencesSearch.search(element);
```

## æœç´¢ä¸€ä¸ªç±»çš„å­ç±»

```java
Query<PsiClass> search = ClassInheritorsSearch.search(psiClass);
```

## æŸ¥è¯¢ç±»æ‰€åœ¨çš„åŒ…

```java
PsiPackage psiPackage = JavaPsiFacade.getInstance(project).findPackage(classQualifiedName);
```

## é‡å‘½å

```java
RefactoringFactory.getInstance(Project).createRename(element, "NewName");
```

## æŸ¥æ‰¾è¢«é‡å†™çš„æ–¹æ³•

```java
Query<PsiMethod> query = OverridingMethodsSearch.search(psiMethod);
```

## è·å– Editor

```java
DataContext context = event.getDataContext();
Editor editor = CommonDataKeys.EDITOR.getData(context);
```

## è·å– Editor é€‰ä¸­çš„æ–‡æœ¬

```java
SelectionModel selectionModel = editor.getSelectionModel();
int start = selectionModel.getSelectionStart();
int end = selectionModel.getSelectionEnd();
TextRange range = new TextRange(start, end);
String selectTxt = document.getText(range);
```

## Editoræ‰“å¼€æŒ‡å®šåç§°çš„æ–‡ä»¶

```java
new OpenFileDescriptor(project, psiFile.getVirtualFile()).navigate(true);
// å…‰æ ‡ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®
int offset = psiFile.getText().indexOf("setContentView");
new OpenFileDescriptor(project, psiFile.getVirtualFile(), offset).navigate(true);
```

## æ ¹æ®ç±»å…¨åæŸ¥è¯¢ PsiClass

```java
PsiClass psiClass = JavaPsiFacade.getInstance(project).findClass(classQualifiedName, GlobalSearchScope.projectScope(project));
```

## æ ¹æ®ç±» SiampleName æŸ¥è¯¢ PsiClass

```java
PsiClass[] psiClasses = PsiShortNamesCache.getInstance(project).getClassesByName(classSimpleName, GlobalSearchScope.projectScope(project));
```

## è·å–é¼ æ ‡é€‰ä¸­çš„ç›®å½•

```java
IdeView view = anActionEvent.getRequiredData(LangDataKeys.IDE_VIEW);
PsiDirectory directory = view.getOrChooseDirectory();
```

## æ’ä»¶é…ç½®å‚æ•°æŒä¹…åŒ–

å½“æ’ä»¶æœ‰ä¸€äº›ç”¨æˆ·å®šåˆ¶çš„é…ç½®å‚æ•°ä¿¡æ¯æ—¶ï¼Œéœ€è¦æ’ä»¶å…·å¤‡è®°å¿†åŠŸèƒ½ï¼Œåœ¨IDEAé‡å¯åï¼Œä»ç„¶èƒ½å¤Ÿç”Ÿæ•ˆï¼Œè¿™å°±éœ€è¦ç”¨åˆ°æ’ä»¶é…ç½®ä¿¡æ¯å®ç°æ¥å£ PersistentStateComponent

## çŠ¶æ€æ è¿›åº¦æ¡

å¦‚æœæœ‰è€—æ—¶ä»»åŠ¡ï¼Œéœ€è¦å¢åŠ è¿›åº¦æ¡ï¼Œå®ç° Task.Backgroundable æŠ½è±¡ç±»ï¼Œé‡å†™ run æ–¹æ³•

## ä½¿ç”¨æ¨¡æ¿

æ’ä»¶å¼€å‘ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶æ¨¡æ¿ï¼Œå°†å…¬å…±éƒ¨åˆ†ä»£ç è¿›è¡ŒæŠ½ç¦»ï¼Œå‡å°‘åˆ›å»ºPSIå¯¹è±¡çš„å¤æ‚ç¨‹åº¦
<br>

é¸£è°¢ï¼š

* [æ’ä»¶SDKä¸­çš„å¸¸ç”¨å¯¹è±¡ä»‹ç»](https://www.jianshu.com/p/a051ace391bd) ğŸ‘
* [IDEA æ’ä»¶å¼€å‘å¸¸ç”¨çš„æ–¹æ³•](https://juejin.im/post/5a0550f56fb9a04527250da1) ğŸ‘