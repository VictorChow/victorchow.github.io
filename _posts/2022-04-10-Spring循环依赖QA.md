---
layout: post
title: Spring å¾ªç¯ä¾èµ– Q&A
date: 2022-04-10
categories: code
tags: Spring
typora-root-url: ../../victorchow.github.io
---

> Spring è§£å†³å¾ªç¯ä¾èµ–ä¸­æ—¶é—´é•¿äº†å®¹æ˜“æ¨¡ç³Šçš„ç‚¹ï¼Œè®°å½•ä¸‹æ¥æ–¹ä¾¿çœ‹

## ä¸‰çº§ç¼“å­˜ä½ç½®

```java
public class DefaultSingletonBeanRegistry extends ... {
    /**
     * ä¸€çº§ç¼“å­˜ï¼Œç¼“å­˜ç”Ÿæˆå¥½çš„å•ä¾‹å¯¹è±¡
     */
    private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);

    /**
     * ä¸‰çº§ç¼“å­˜ï¼Œç¼“å­˜ã€å¯¹å·²ç»å®ä¾‹åŒ–çš„Beanæå‰æ‰§è¡Œè¯¥Beanæ‰€æœ‰BeanPostProcessorã€çš„å»¶è¿Ÿå¤„ç†
     */
    private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);
  
    /**
     * äºŒçº§ç¼“å­˜ï¼Œç¼“å­˜å·²ç»å®ä¾‹åŒ–å¹¶æå‰æ‰§è¡Œå®Œè¯¥Beanæ‰€æœ‰BeanPostProcessorçš„Beanï¼ˆæ­¤æ—¶è¿˜æœªå¡«å……åŠåˆå§‹åŒ–ï¼‰
     */
    private final Map<String, Object> earlySingletonObjects = new HashMap<>(16);
}
```

## Spring å¤„ç† Bean çš„ä¸»è¦æµç¨‹

1. å®ä¾‹åŒ– Beanï¼Œç”Ÿæˆå¯¹è±¡ï¼›
2. å¡«å…… Beanï¼Œå¤„ç† Bean çš„å±æ€§ä¾èµ–ï¼›
3. åˆå§‹åŒ– Beanï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ã€ BeanPostProcessorã€‚

## Spring è§£å†³å¾ªç¯ä¾èµ–çš„å…³é”®æµç¨‹

**DefaultSingletonBeanRegistry** ç±»ä¸­ï¼Œè§£å†³å¾ªç¯ä¾èµ–çš„æµç¨‹

```java
protected Object getSingleton(String beanName, boolean allowEarlyReference) {
   //ä»å•ä¾‹å¯¹è±¡ï¼ˆä¸€çº§ç¼“å­˜ï¼‰ä¸­è·å–
   Object singletonObject = this.singletonObjects.get(beanName);
   //ä¸åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”è¯¥Beanæ­£åœ¨åˆ›å»ºä¸­
   if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {
      synchronized (this.singletonObjects) {
         //ä»æå‰æ‰§è¡Œå®ŒBeanPostProcessorçš„Beançš„ç¼“å­˜ï¼ˆäºŒçº§ç¼“å­˜ï¼‰ä¸­è·å–
         singletonObject = this.earlySingletonObjects.get(beanName);
         //ä¸åœ¨äºŒçº§ç¼“å­˜ä¸­
         if (singletonObject == null && allowEarlyReference) {
            //è·å–è¯¥Beançš„ObjectFactoryï¼ˆä¸‰çº§ç¼“å­˜ï¼‰ï¼Œç”¨äºæå‰æ‰§è¡Œå¯¹è¯¥Beançš„æ‰€æœ‰BeanPostProcessor
            ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);
            if (singletonFactory != null) {
               //æ‰§è¡Œæ‰€æœ‰BeanPostProcessor
               singletonObject = singletonFactory.getObject();
               //åŠ å…¥äºŒçº§ç¼“å­˜
               this.earlySingletonObjects.put(beanName, singletonObject);
               //ç§»é™¤ä¸‰çº§ç¼“å­˜
               this.singletonFactories.remove(beanName);
            }
         }
      }
   }
   return singletonObject;
}
```

## ä¸ºä»€ä¹ˆè¦ç¼“å­˜ ObjectFactory çš„å»¶è¿Ÿå¤„ç†

ç»“åˆ Spring å¯¹ Bean çš„å¤„ç†è¿‡ç¨‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ BeanPostProcessor çš„æ‰§è¡Œæ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™å»åšï¼Œè€Œä¸”å¹¶ä¸æ˜¯æ‰€æœ‰ Bean éƒ½æœ‰ AOPï¼ˆå¢å¼ºæ—§å¯¹è±¡ï¼Œè¿”å›å¢å¼ºåçš„æ–°å¯¹è±¡ï¼‰çš„éœ€æ±‚ï¼Œåªæœ‰åœ¨é‡åˆ°å¾ªç¯ä¾èµ–çš„åœºæ™¯ï¼Œæ‰éœ€è¦æå‰æ‰§è¡Œ BeanPostProcessorï¼Œä»¥ä¾¿èƒ½è®©å…¶ä»– Bean è·å–åˆ°å¢å¼ºåçš„ Beanã€‚

æ‰€ä»¥è®©æ‰€æœ‰ Bean éƒ½æå‰æ‰§è¡Œ BeanPostProcessor æ˜¯ä¸åˆé€‚çš„ï¼Œç¼“å­˜äº† ObjectFactory ä¹‹åï¼Œå¦‚æœé‡åˆ°å¾ªç¯ä¾èµ–å°±è°ƒç”¨ï¼ˆæå‰å¢å¼ºï¼‰ï¼Œæ²¡æœ‰é‡åˆ°å¾ªç¯ä¾èµ–å°±ä¸è°ƒç”¨ï¼ˆèµ°æ­£å¸¸çš„ Bean çš„å¤„ç†è¿‡ç¨‹ï¼‰ï¼Œè¿™æ ·æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚

## singletonFactories åœ¨ä»€ä¹ˆæ—¶æœºç¼“å­˜å’Œç§»é™¤

* ### ç¼“å­˜ï¼š

  **AbstractAutowireCapableBeanFactory#doCreateBean**

  ```java
  addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
  ```

  **DefaultSingletonBeanRegistry** ç±»ä¸­ç¼“å­˜ singletonFactories

  ```java
  protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory) {
      synchronized (this.singletonObjects) {
        if (!this.singletonObjects.containsKey(beanName)) {
           //è¿™é‡Œ
           this.singletonFactories.put(beanName, singletonFactory);
           this.earlySingletonObjects.remove(beanName);
           this.registeredSingletons.add(beanName);
        }
     }
  }
  ```

  **AbstractAutowireCapableBeanFactory** ç±»ä¸­è·å– SmartInstantiationAwareBeanPostProcessor å¹¶æ‰§è¡Œ

  ```java
  protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
     Object exposedObject = bean;
     if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
        for (BeanPostProcessor bp : getBeanPostProcessors()) {
           if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {
              SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
              exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);
           }
        }
     }
     return exposedObject;
  }
  ```

* ### ç§»é™¤

  **DefaultSingletonBeanRegistry** ç±»ä¸­ï¼Œæ­£å¸¸ Bean æµç¨‹

  ```java
  protected void addSingleton(String beanName, Object singletonObject) {
      synchronized (this.singletonObjects) {
          this.singletonObjects.put(beanName, singletonObject);
          //è¿™é‡Œ
          this.singletonFactories.remove(beanName);
          this.earlySingletonObjects.remove(beanName);
          this.registeredSingletons.add(beanName);
      }
  }
  ```
  
  **DefaultSingletonBeanRegistry** ç±»ä¸­ï¼Œè§£å†³å¾ªç¯ä¾èµ–çš„æµç¨‹
  
  ```java
  protected Object getSingleton(String beanName, boolean allowEarlyReference) {
     Object singletonObject = this.singletonObjects.get(beanName);
     if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {
        synchronized (this.singletonObjects) {
           singletonObject = this.earlySingletonObjects.get(beanName);
           if (singletonObject == null && allowEarlyReference) {
              ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);
              if (singletonFactory != null) {
                 singletonObject = singletonFactory.getObject();
                 this.earlySingletonObjects.put(beanName, singletonObject);
                 //è¿™é‡Œ
                 this.singletonFactories.remove(beanName);
              }
           }
        }
     }
     return singletonObject;
  }
  ```

## ä¸ºä»€ä¹ˆéœ€è¦ earlySingletonObjects

earlySingletonObjects å­˜çš„æ˜¯å·²ç»å®ä¾‹åŒ–å¹¶æå‰æ‰§è¡Œå®Œè¯¥ Bean æ‰€æœ‰ BeanPostProcessor çš„ Beanï¼Œä½†æ­¤æ—¶ Bean è¿˜æœªå¡«å……ï¼Œå¦‚æœæ²¡æœ‰ earlySingletonObjectsï¼Œä¸‹é¢è¿™ä¸ªåœºæ™¯ä¼šå‡ºç°é—®é¢˜ï¼š

```java
@Component
public class B {
  
    @Autowired
    private A a;
}

@Component
public class A {
  
    @Autowired
    private B b1;
  
    @Autowired
    private B b2;
}
```

1. å¯¹ A æ‰§è¡Œå¡«å……æ—¶ï¼Œå…ˆå¤„ç† b1 å±æ€§ï¼Œæ­¤æ—¶ B åœ¨ singletonObjects ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å…ˆå®ä¾‹åŒ– Bï¼Œå†ä» singletonFactories ä¸­æŸ¥æ‰¾åˆ° B çš„æå‰æ‰§è¡Œ BeanPostProcessor çš„ ObjectFactoryï¼Œè°ƒç”¨ getObject è·å–åˆ°æå‰æ‰§è¡Œ BeanPostProcessor çš„å¢å¼º B å®ä¾‹ï¼Œæ³¨å…¥åˆ° b1 å±æ€§ä¸­ï¼›
2. åˆ°äº† b2 è¿™ä¸ªå±æ€§æ—¶ï¼Œç”±äº B åœ¨ singletonObjects ä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä»ç„¶éœ€è¦è·å– B çš„ ObjectFactoryï¼Œæ‰§è¡Œ getObjectï¼Œå¯¼è‡´åˆå¯¹ B æ‰§è¡Œäº†ä¸€é BeanPostProcessorã€‚

æ‰€ä»¥ä¸ºäº†å¤„ç†å¤šæ¬¡å¼•ç”¨çš„é—®é¢˜ï¼Œéœ€è¦è¿™ä¸ªä¸­é—´çŠ¶æ€çš„ç¼“å­˜å®¹å™¨ earlySingletonObjectsï¼Œç”¨æ¥ç¼“å­˜å®ä¾‹åŒ–ä¹‹ååˆæå‰æ‰§è¡Œäº† BeanPostProcessor çš„ Beanï¼Œæ­¤æ—¶ b2 å¯ä»¥ç›´æ¥ä» earlySingletonObjects ä¸­å»è·å–ï¼Œä¸ä¼šé‡å¤æ‰§è¡Œ ObjectFactory çš„ getObject æ–¹æ³•ã€‚

## earlySingletonObjects åœ¨ä»€ä¹ˆæ—¶æœºç¼“å­˜å’Œç§»é™¤

* ### ç¼“å­˜

  **DefaultSingletonBeanRegistry** ç±»ä¸­ï¼Œè§£å†³å¾ªç¯ä¾èµ–çš„æµç¨‹

  ```java
  protected Object getSingleton(String beanName, boolean allowEarlyReference) {
     Object singletonObject = this.singletonObjects.get(beanName);
     if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {
        synchronized (this.singletonObjects) {
           singletonObject = this.earlySingletonObjects.get(beanName);
           if (singletonObject == null && allowEarlyReference) {
              ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);
              if (singletonFactory != null) {
                 singletonObject = singletonFactory.getObject();
                 //è¿™é‡Œ
                 this.earlySingletonObjects.put(beanName, singletonObject);
                 this.singletonFactories.remove(beanName);
              }
           }
        }
     }
     return singletonObject;
  }
  ```

* ### ç§»é™¤

  **DefaultSingletonBeanRegistry** ç±»ä¸­ï¼Œæ­£å¸¸ Bean æµç¨‹

  ```java
  protected void addSingleton(String beanName, Object singletonObject) {
      synchronized (this.singletonObjects) {
          this.singletonObjects.put(beanName, singletonObject);
          this.singletonFactories.remove(beanName);
          //è¿™é‡Œ
          this.earlySingletonObjects.remove(beanName);
          this.registeredSingletons.add(beanName);
      }
  }
  ```

  **DefaultSingletonBeanRegistry** ç±»ä¸­ï¼Œç¼“å­˜ ObjectFactory æ—¶

  ```java
  protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory) {
     synchronized (this.singletonObjects) {
        if (!this.singletonObjects.containsKey(beanName)) {
           this.singletonFactories.put(beanName, singletonFactory);
           //è¿™é‡Œ
           this.earlySingletonObjects.remove(beanName);
           this.registeredSingletons.add(beanName);
        }
     }
  }
  ```

## å¦‚ä½•é¿å… BeanPostProcessor é‡å¤æ‰§è¡Œ

ç»“åˆ Spring å¯¹ Bean çš„å¤„ç†è¿‡ç¨‹ï¼Œåœ¨è§£å†³å¾ªç¯ä¾èµ–çš„æ—¶å€™ï¼ŒBean åœ¨å¡«å……é˜¶æ®µï¼Œå·²ç»æå‰æ‰§è¡Œäº† singletonFactories ä¸­çš„ã€Œå¯¹è¯¥ Bean æå‰æ‰§è¡Œæ‰€æœ‰çš„ BeanPostProcessorã€æ–¹æ³•ï¼Œä½†åœ¨ Bean åˆå§‹åŒ–æ—¶è¿˜ä¼šå†æ¬¡æ‰§è¡Œ BeanPostProcessorï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æ‰§è¡Œä¸¤æ¬¡ã€‚

Spring æä¾›äº† SmartInstantiationAwareBeanPostProcessor æ¥å£ï¼Œéœ€è¦å¢å¼º Bean çš„ BeanPostProcessor å¯ä»¥å®ç°æ­¤æ¥å£ï¼Œ å¹¶å¢åŠ ä¸€ä¸ªç¼“å­˜ï¼Œç”¨æ¥å­˜å‚¨å·²ç»å¢å¼ºçš„ Bean ï¼Œæ¯æ¬¡è°ƒç”¨è¯¥ BeanPostProcessor çš„æ—¶å€™ï¼Œå¦‚æœç¼“å­˜ä¸­å·²ç»å­˜åœ¨é‚£å°±è¯´æ˜åˆ›å»ºè¿‡äº†ï¼Œç›´æ¥è¿”å›ä¸Šæ¬¡åˆ›å»ºçš„å³å¯ï¼Œé¿å…é‡å¤å¢å¼ºã€‚ 

## Spring æ— æ³•è§£å†³ä»€ä¹ˆåœºæ™¯çš„å¾ªç¯ä¾èµ–

æ„é€ å™¨æ³¨å…¥çš„åœºæ™¯æ— æ³•è§£å†³ï¼Œå› ä¸ºæ„é€ å™¨æ³¨å…¥çš„æ—¶å€™ Bean è¿˜æœªå®Œæˆå®ä¾‹åŒ–ï¼Œæ›´åˆ«ææ”¾å…¥ç¼“å­˜äº†ï¼Œæ²¡æ”¾å…¥ç¼“å­˜å°±æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

setter æ³¨å…¥å¹³æ—¥ä¸ä½¿ç”¨ï¼Œä¸åšç ”ç©¶ã€‚

## ä¸¾ä¸ªæ —å­ğŸŒ°

ç»“åˆä¸€ä¸ªå…·ä½“çš„åœºæ™¯ï¼ŒA å’Œ B äº’ç›¸ä¾èµ–ï¼Œå¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š

```java
@Component
public class A {
    @Autowired
    private B b;
}

@Component
public class B {  
    @Autowired
    private A a;
}
```

1. å¼€æï¼Œæ­¤æ—¶ç¼“å­˜ä¸­å•¥ä¹Ÿæ²¡æœ‰

   | singletonObjectsï¼ˆä¸€çº§ï¼‰ | earlySingletonObjectsï¼ˆäºŒçº§ï¼‰ | singletonFactoriesï¼ˆä¸‰çº§ï¼‰ |
   | ------------------------ | ----------------------------- | -------------------------- |
   |                          |                               |                            |

2. ç¼“å­˜ä¸­ä¸å­˜åœ¨ Aï¼Œæ‰€ä»¥å®ä¾‹åŒ– Aï¼Œç”Ÿæˆäº† a1 å¯¹è±¡ï¼Œåœ¨ä¸‰çº§ç¼“å­˜ä¸­æ·»åŠ å¯¹ a1 æ‰§è¡Œæ‰€æœ‰ BeanPostProcessor çš„å»¶è¿Ÿå¤„ç†

   | singletonObjectsï¼ˆä¸€çº§ï¼‰ | earlySingletonObjectsï¼ˆäºŒçº§ï¼‰ | singletonFactoriesï¼ˆä¸‰çº§ï¼‰ |
   | ------------------------ | ----------------------------- | -------------------------- |
   |                          |                               | A â†’ `ObjectFactory(a1)`    |

3. å¯¹ a1 è¿›è¡Œå¡«å……ï¼Œå‘ç°äº† B çš„å¼•ç”¨ï¼Œè¦å¯¹ a1 ä¸­çš„ b å¯¹è±¡è¿›è¡Œæ³¨å…¥ï¼ŒåŒæ ·åœ°ç¼“å­˜ä¸­ä¸å­˜åœ¨ Bï¼Œä¹Ÿæ˜¯å…ˆå®ä¾‹åŒ– Bï¼Œç”Ÿæˆäº† b1 å¯¹è±¡ï¼Œåœ¨ä¸‰çº§ç¼“å­˜ä¸­æ·»åŠ å¯¹ b1 æ‰§è¡Œæ‰€æœ‰ BeanPostProcessor çš„å»¶è¿Ÿå¤„ç†

   | singletonObjectsï¼ˆä¸€çº§ï¼‰ | earlySingletonObjectsï¼ˆäºŒçº§ï¼‰ | singletonFactoriesï¼ˆä¸‰çº§ï¼‰                           |
   | ------------------------ | ----------------------------- | ---------------------------------------------------- |
   |                          |                               | A â†’ `ObjectFactory(a1)`<br />B â†’ `ObjectFactoty(b1)` |

4. å¯¹ b1 è¿›è¡Œå¡«å……ï¼Œå‘ç°äº† A å¼•ç”¨ï¼Œå‰ä¸¤çº§ç¼“å­˜ä¸­æ²¡æœ‰ Aï¼Œä¸‰çº§ç¼“å­˜ä¸­æ‰¾åˆ°äº† A çš„ ObjectFactory å¹¶æ‰§è¡Œï¼Œå°†è¿”å›çš„ç»“æœ `Proxy$a1`ï¼ˆå¢å¼ºåçš„a1ï¼‰ æ”¾å…¥äºŒçº§ç¼“å­˜ä¸­ï¼ŒåŒæ—¶åœ¨ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ A

   | singletonObjectsï¼ˆä¸€çº§ï¼‰ | earlySingletonObjectsï¼ˆäºŒçº§ï¼‰ | singletonFactoriesï¼ˆä¸‰çº§ï¼‰ |
   | ------------------------ | ----------------------------- | -------------------------- |
   |                          | A â†’ `Proxy$a1`                | B â†’ `ObjectFactoty(b1)`    |

5. å°† `Proxy$a1` æ³¨å…¥åˆ° b1 å¯¹è±¡çš„ a å±æ€§ï¼ŒB å¡«å……å®Œæˆï¼Œæ‰§è¡Œåˆå§‹åŒ–ã€BeanPostProcessor åï¼Œå®Œæˆåˆ›å»ºå•ä¾‹è¿‡ç¨‹ï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜ä¸­ï¼Œç§»é™¤ B çš„ä¸‰çº§ç¼“å­˜

   æ³¨æ„ï¼šå¦‚æœ BeanPostProcessor æœ‰å¢å¼º b1ï¼Œåˆ™ä¸€çº§ç¼“å­˜ä¸­ç¼“å­˜çš„ä¸º `Proxy$b1`ï¼Œå¦åˆ™ä¸º b1

   | ingletonObjectsï¼ˆä¸€çº§ï¼‰ | earlySingletonObjectsï¼ˆäºŒçº§ï¼‰ | singletonFactoriesï¼ˆä¸‰çº§ï¼‰ |
   | ----------------------- | ----------------------------- | -------------------------- |
   | B â†’ `Proxy$b1`          | A â†’ `Proxy$a1`                |                            |

6. å°† `Proxy$b1` æ³¨å…¥åˆ° a1 çš„ b å±æ€§ï¼Œa1 å¯¹è±¡å¡«å……å®Œæ¯•ï¼Œæ‰§è¡Œåˆå§‹åŒ–ã€BeanPostProcessorï¼Œå› ä¸ºæœ‰ SmartInstantiationAwareBeanPostProcessor çš„å­˜åœ¨ï¼Œæœ€ç»ˆå¢å¼ºåçš„å¯¹è±¡ä»ç„¶æ˜¯ `Proxy$a1`ï¼Œå®Œæˆ A çš„å•ä¾‹åˆ›å»ºï¼Œæ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ï¼Œä»äºŒçº§ç¼“å­˜ä¸­ç§»é™¤

   | ingletonObjectsï¼ˆä¸€çº§ï¼‰            | earlySingletonObjectsï¼ˆäºŒçº§ï¼‰ | singletonFactoriesï¼ˆä¸‰çº§ï¼‰ |
   | ---------------------------------- | ----------------------------- | -------------------------- |
   | B â†’ `Proxy$b1`<br />A â†’ `Proxy$a1` |                               |                            |

7. ä¸¤ä¸ªå¯¹è±¡åˆ›å»ºå®Œæ¯•
